machine:
  services:
    - docker

dependencies:
  post:
    - docker build -t tanmayawasekar/share-a-meal-api:$CIRCLE_BUILD_NUM .

test:
  post:
    - docker run -d -p 8080:8080 --name share-a-meal-api tanmayawasekar/share-a-meal-api:$CIRCLE_BUILD_NUM; sleep 10
    - curl --retry 10 --retry-delay 5 localhost:8080 | grep "Hello World!"
    

deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh
      # - docker login -e "$DOCKER_EMAIL" -u "$DOCKER_USER" -p "$DOCKER_PASS"
      # - docker build -t "tanmayawasekar/share-a-meal-api:$CIRCLE_BUILD_NUM" .
      # - docker push "tanmayawasekar/share-a-meal-api:$CIRCLE_BUILD_NUM"
      # - sed -i'' -e "s;%BUILD_NUM%;$CIRCLE_BUILD_NUM;g" ./.deploy/Dockerrun.aws.json
      # - cd .deploy && eb init -r us-east-1 getantibody
      # - cd .deploy && eb deploy -l $CIRCLE_BUILD_NUM